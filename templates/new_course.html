{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Yeni Kurs Oluştur</h3>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="title" class="form-label">Kurs Başlığı</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Kurs Açıklaması</label>
                        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="category_id" class="form-label">Kategori</label>
                        <select class="form-control" id="category_id" name="category_id" required>
                            <option value="">Kategori Seçin</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold" style="font-size:1.1rem;">Eğitimi Alacak Kullanıcılar</label>
                        <div class="list-group user-select-list shadow rounded-4" style="max-height: 250px; overflow-y: auto;">
                            {% for user in users if not user.is_admin %}
                            <label class="list-group-item d-flex align-items-center gap-2 user-select-item rounded-3 mb-2" style="cursor:pointer; border: none;">
                                <input class="form-check-input me-2 big-checkbox" type="checkbox" name="assigned_users" value="{{ user.id }}" onchange="this.parentElement.classList.toggle('selected', this.checked)">
                                <span class="user-info fw-bold" style="font-size:1.05rem;">
                                    <i class="bi bi-person-circle me-1"></i>{{ user.first_name }} {{ user.last_name }}
                                    <span class="badge bg-light text-dark ms-2">{{ user.username }}</span>
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                        <small class="form-text text-muted">Birden fazla kullanıcı seçebilirsiniz.</small>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-bold">Kurs İçeriği</label>
                        <div id="content-inputs" class="mb-3">
                            <!-- Dinamik içerik girişleri buraya eklenecek -->
                        </div>
                        <button type="button" class="btn btn-outline-primary" onclick="addContentInput('video')"><i class="bi bi-camera-video"></i> + Video Ekle</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="addContentInput('pdf')"><i class="bi bi-file-earmark-pdf"></i> + PDF Ekle</button>
                    </div>

                    <hr class="my-4">

                    <div class="form-check mb-3 p-3 rounded-3" style="background-color: #e9ecef;">
                        <input class="form-check-input" type="checkbox" id="test_required" name="test_required" checked style="width: 1.2em; height: 1.2em;">
                        <label class="form-check-label fw-bold ps-2" for="test_required" style="font-size: 1.1rem;">
                            Bu kursu tamamlamak için test zorunlu mu?
                        </label>
                    </div>

                    <div id="test_fields_wrapper" class="mt-4">
                        <div class="p-3 border rounded-3">
                            <h5 class="fw-bold mb-3">Test Detayları</h5>
                            <div class="mb-3">
                                <label class="form-label">Test Dosyası (PDF veya Fotoğraf)</label>
                                <input type="file" class="form-control" name="test_file" accept="application/pdf,image/*">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Soru Sayısı</label>
                                <input type="number" class="form-control" name="pdf_question_count" min="1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Cevap Anahtarı (örn: A,B,C,D,A...)</label>
                                <input type="text" class="form-control" name="pdf_answer_key" placeholder="A,B,C,D,A">
                            </div>
                            <div class="mb-3">
                                <label for="passing_score" class="form-label">Geçme Notu</label>
                                <input type="number" class="form-control" id="passing_score" name="passing_score" value="70">
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">

                    <!-- Upload Progress Bar -->
                    <div id="upload-progress" class="mb-3" style="display: none;">
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                                <div class="flex-grow-1">
                                    <div><strong>Kurs oluşturuluyor...</strong></div>
                                    <div class="progress mt-2">
                                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small id="progress-text" class="text-muted">Dosyalar işleniyor...</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File Size Warning -->
                    <div id="file-size-warning" class="alert alert-warning" style="display: none;">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Uyarı:</strong> Büyük dosyalar yükleniyor. İşlem uzun sürebilir.
                    </div>

                    <div class="d-grid">
                        <button type="submit" id="submit-btn" class="btn btn-primary">
                            <span id="submit-text">Kursu Oluştur</span>
                            <span id="submit-spinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="list-group">
    {% if videos %}
        {% for video in videos %}
            <!-- video kartı -->
        {% endfor %}
    {% else %}
        <div class="alert alert-info m-3">Bu kursa henüz video eklenmemiş.</div>
    {% endif %}
</div>

<style>
.user-select-list {
    background: linear-gradient(120deg, #e0eafc 0%, #cfdef3 100%);
    padding: 12px 8px;
}
.user-select-item {
    background: rgba(255,255,255,0.6);
    border: 1.5px solid #e0eafc;
    margin-bottom: 8px;
    transition: background 0.2s, box-shadow 0.2s, color 0.2s;
    box-shadow: 0 2px 8px 0 rgba(79,140,255,0.04);
}
.user-select-item:hover {
    background: linear-gradient(90deg, #a1c4fd 0%, #c2e9fb 100%);
    box-shadow: 0 2px 12px 0 rgba(79,140,255,0.12);
}
.user-select-item.selected {
    background: linear-gradient(90deg, #4f8cff 0%, #6a82fb 100%) !important;
    color: #fff !important;
    border-color: #4f8cff;
}
.user-select-item.selected .user-info {
    color: #fff !important;
}
.user-select-item.selected .badge {
    background: #fff !important;
    color: #4f8cff !important;
    font-weight: bold;
}
.user-info {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
}
.big-checkbox {
    width: 1.3em;
    height: 1.3em;
    border-radius: 50%;
    border: 2px solid #4f8cff;
    accent-color: #4f8cff;
    margin-right: 10px;
}
.drag-handle {
    cursor: grab;
    color: #a0aec0;
}
.drag-handle:hover {
    color: #4f8cff;
}
</style>

{% block scripts %}
<script>
let contentOrder = 0;
let totalUploadSize = 0;
let largeFileWarningShown = false;

// File size constants (in bytes)
const MAX_FILE_SIZE = 500 * 1024 * 1024; // 500MB
const LARGE_FILE_THRESHOLD = 100 * 1024 * 1024; // 100MB
const WARNING_TOTAL_SIZE = 1000 * 1024 * 1024; // 1GB total

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function checkFileSize(fileInput) {
    const file = fileInput.files[0];
    if (!file) return true;
    
    const fileSize = file.size;
    const fileName = file.name;
    
    // Maximum file size check
    if (fileSize > MAX_FILE_SIZE) {
        alert(`❌ Dosya çok büyük!\n\n${fileName}: ${formatFileSize(fileSize)}\nMaximum: ${formatFileSize(MAX_FILE_SIZE)}\n\nLütfen daha küçük bir dosya seçin.`);
        fileInput.value = '';
        return false;
    }
    
    // Large file warning
    if (fileSize > LARGE_FILE_THRESHOLD) {
        if (!largeFileWarningShown) {
            document.getElementById('file-size-warning').style.display = 'block';
            largeFileWarningShown = true;
        }
        console.log(`⚠️ Büyük dosya: ${fileName} (${formatFileSize(fileSize)})`);
    }
    
    return true;
}

function calculateTotalUploadSize() {
    totalUploadSize = 0;
    const fileInputs = document.querySelectorAll('input[type="file"]');
    
    fileInputs.forEach(input => {
        if (input.files[0]) {
            totalUploadSize += input.files[0].size;
        }
    });
    
    // Show warning if total size is large
    if (totalUploadSize > WARNING_TOTAL_SIZE) {
        document.getElementById('file-size-warning').style.display = 'block';
        largeFileWarningShown = true;
    }
    
    console.log(`📊 Toplam upload boyutu: ${formatFileSize(totalUploadSize)}`);
}

function addContentInput(type) {
    const container = document.getElementById('content-inputs');
    const row = document.createElement('div');
    row.className = 'row g-3 mb-3 p-3 border rounded-3 align-items-center content-input-row';
    
    const fileAccept = type === 'video' ? 'video/*' : 'application/pdf';
    const placeholder = type === 'video' ? 'Video Başlığı' : 'PDF Başlığı';
    const maxSizeText = type === 'video' ? '(Max: 500MB)' : '(Max: 500MB)';

    row.innerHTML = `
        <input type="hidden" name="content_types[]" value="${type}">
        <input type="hidden" name="content_orders[]" class="content-order-input" value="${contentOrder}">
        <div class="col-md-1 text-center">
            <i class="bi bi-grip-vertical drag-handle"></i>
        </div>
        <div class="col-md-5">
            <input type="text" class="form-control" name="content_titles[]" placeholder="${placeholder}" required>
        </div>
        <div class="col-md-5">
            <input type="file" class="form-control file-input" name="content_files[]" accept="${fileAccept}" required>
            <small class="text-muted">${maxSizeText}</small>
        </div>
        <div class="col-md-1 text-end">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.content-input-row').remove(); updateContentOrder(); calculateTotalUploadSize();">Kaldır</button>
        </div>
    `;
    container.appendChild(row);
    
    // Add file size check to the new file input
    const fileInput = row.querySelector('.file-input');
    fileInput.addEventListener('change', function() {
        if (checkFileSize(this)) {
            calculateTotalUploadSize();
        }
    });
    
    contentOrder++;
}

function updateContentOrder() {
    const rows = document.querySelectorAll('#content-inputs .content-input-row');
    rows.forEach((row, index) => {
        row.querySelector('.content-order-input').value = index;
    });
    contentOrder = rows.length;
}

document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('content-inputs');
    if(container) {
        new Sortable(container, {
            animation: 150,
            handle: '.drag-handle',
            onEnd: function() {
                updateContentOrder();
            }
        });
    }

    if (container.children.length === 0) {
        addContentInput('video');
    }

    const testRequiredCheckbox = document.getElementById('test_required');
    const testFieldsWrapper = document.getElementById('test_fields_wrapper');
    if (testRequiredCheckbox && testFieldsWrapper) {
        const testInputs = testFieldsWrapper.querySelectorAll('input, select');

        const toggleTestFields = () => {
            const isChecked = testRequiredCheckbox.checked;
            testFieldsWrapper.style.display = isChecked ? 'block' : 'none';
            testInputs.forEach(input => {
                if (isChecked) {
                    if (input.name === 'test_file') {
                        input.setAttribute('required', 'required');
                    } else {
                        input.removeAttribute('required');
                    }
                } else {
                    input.removeAttribute('required');
                    if (input.type !== 'checkbox' && input.type !== 'radio') {
                       input.value = '';
                    }
                }
            });
        };

        toggleTestFields();
        testRequiredCheckbox.addEventListener('change', toggleTestFields);
    }

    // Test file size check
    const testFileInput = document.querySelector('input[name="test_file"]');
    if (testFileInput) {
        testFileInput.addEventListener('change', function() {
            checkFileSize(this);
            calculateTotalUploadSize();
        });
    }

    // Form submission handling with progress tracking
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitSpinner = document.getElementById('submit-spinner');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');

    form.addEventListener('submit', function(e) {
        // Validate all files before submission
        const fileInputs = document.querySelectorAll('input[type="file"]');
        let hasValidationError = false;
        
        fileInputs.forEach(input => {
            if (input.files[0] && !checkFileSize(input)) {
                hasValidationError = true;
            }
        });
        
        if (hasValidationError) {
            e.preventDefault();
            return;
        }

        // Calculate final total size
        calculateTotalUploadSize();
        
        // Show progress and disable submit button
        submitBtn.disabled = true;
        submitText.textContent = 'Yükleniyor...';
        submitSpinner.style.display = 'inline-block';
        uploadProgress.style.display = 'block';
        
        // Simulate progress (since we can't track real upload progress with regular form submission)
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) {
                progress = 90;
                clearInterval(progressInterval);
                progressText.textContent = 'Son işlemler yapılıyor...';
            }
            progressBar.style.width = progress + '%';
            
            if (progress < 30) {
                progressText.textContent = 'Dosyalar yükleniyor...';
            } else if (progress < 60) {
                progressText.textContent = 'Kurs oluşturuluyor...';
            } else if (progress < 90) {
                progressText.textContent = 'İçerik işleniyor...';
            }
        }, 500);
        
        // Show estimated time based on file size
        const estimatedSeconds = Math.ceil(totalUploadSize / (1024 * 1024)); // Rough estimate: 1MB per second
        if (estimatedSeconds > 10) {
            setTimeout(() => {
                if (!form.submitted) {
                    progressText.textContent = `Tahmini süre: ${estimatedSeconds} saniye...`;
                }
            }, 2000);
        }
    });
});
</script>
{% endblock %}
{% endblock %} 