{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Yeni Kurs Oluştur</h3>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="title" class="form-label">Kurs Başlığı</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Kurs Açıklaması</label>
                        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="category_id" class="form-label">Kategori</label>
                        <select class="form-control" id="category_id" name="category_id" required>
                            <option value="">Kategori Seçin</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold" style="font-size:1.1rem;">Eğitimi Alacak Kullanıcılar</label>
                        <div class="list-group user-select-list shadow rounded-4" style="max-height: 250px; overflow-y: auto;">
                            {% for user in users if not user.is_admin %}
                            <label class="list-group-item d-flex align-items-center gap-2 user-select-item rounded-3 mb-2" style="cursor:pointer; border: none;">
                                <input class="form-check-input me-2 big-checkbox" type="checkbox" name="assigned_users" value="{{ user.id }}" onchange="this.parentElement.classList.toggle('selected', this.checked)">
                                <span class="user-info fw-bold" style="font-size:1.05rem;">
                                    <i class="bi bi-person-circle me-1"></i>{{ user.first_name }} {{ user.last_name }}
                                    <span class="badge bg-light text-dark ms-2">{{ user.username }}</span>
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                        <small class="form-text text-muted">Birden fazla kullanıcı seçebilirsiniz.</small>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-bold">Kurs İçeriği</label>
                        <div id="content-inputs" class="mb-3">
                            <!-- Dinamik içerik girişleri buraya eklenecek -->
                        </div>
                        <button type="button" class="btn btn-outline-primary" onclick="addContentInput('video')"><i class="bi bi-camera-video"></i> + Video Ekle</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="addContentInput('pdf')"><i class="bi bi-file-earmark-pdf"></i> + PDF Ekle</button>
                    </div>

                    <hr class="my-4">

                    <div class="form-check mb-3 p-3 rounded-3" style="background-color: #e9ecef;">
                        <input class="form-check-input" type="checkbox" id="test_required" name="test_required" checked style="width: 1.2em; height: 1.2em;">
                        <label class="form-check-label fw-bold ps-2" for="test_required" style="font-size: 1.1rem;">
                            Bu kursu tamamlamak için test zorunlu mu?
                        </label>
                    </div>

                    <div id="test_fields_wrapper" class="mt-4">
                        <div class="p-3 border rounded-3">
                            <h5 class="fw-bold mb-3">Test Detayları</h5>
                            <div class="mb-3">
                                <label class="form-label">Test Dosyası (PDF veya Fotoğraf)</label>
                                <input type="file" class="form-control" name="test_file" accept="application/pdf,image/*">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Soru Sayısı</label>
                                <input type="number" class="form-control" name="pdf_question_count" min="1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Cevap Anahtarı (örn: A,B,C,D,A...)</label>
                                <input type="text" class="form-control" name="pdf_answer_key" placeholder="A,B,C,D,A">
                            </div>
                            <div class="mb-3">
                                <label for="passing_score" class="form-label">Geçme Notu</label>
                                <input type="number" class="form-control" id="passing_score" name="passing_score" value="70">
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Kursu Oluştur</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="list-group">
    {% if videos %}
        {% for video in videos %}
            <!-- video kartı -->
        {% endfor %}
    {% else %}
        <div class="alert alert-info m-3">Bu kursa henüz video eklenmemiş.</div>
    {% endif %}
</div>

<style>
.user-select-list {
    background: linear-gradient(120deg, #e0eafc 0%, #cfdef3 100%);
    padding: 12px 8px;
}
.user-select-item {
    background: rgba(255,255,255,0.6);
    border: 1.5px solid #e0eafc;
    margin-bottom: 8px;
    transition: background 0.2s, box-shadow 0.2s, color 0.2s;
    box-shadow: 0 2px 8px 0 rgba(79,140,255,0.04);
}
.user-select-item:hover {
    background: linear-gradient(90deg, #a1c4fd 0%, #c2e9fb 100%);
    box-shadow: 0 2px 12px 0 rgba(79,140,255,0.12);
}
.user-select-item.selected {
    background: linear-gradient(90deg, #4f8cff 0%, #6a82fb 100%) !important;
    color: #fff !important;
    border-color: #4f8cff;
}
.user-select-item.selected .user-info {
    color: #fff !important;
}
.user-select-item.selected .badge {
    background: #fff !important;
    color: #4f8cff !important;
    font-weight: bold;
}
.user-info {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
}
.big-checkbox {
    width: 1.3em;
    height: 1.3em;
    border-radius: 50%;
    border: 2px solid #4f8cff;
    accent-color: #4f8cff;
    margin-right: 10px;
}
.drag-handle {
    cursor: grab;
    color: #a0aec0;
}
.drag-handle:hover {
    color: #4f8cff;
}
</style>

{% block scripts %}
<script>
let contentOrder = 0;

function addContentInput(type) {
    const container = document.getElementById('content-inputs');
    const row = document.createElement('div');
    row.className = 'row g-3 mb-3 p-3 border rounded-3 align-items-center content-input-row';
    
    const fileAccept = type === 'video' ? 'video/*' : 'application/pdf';
    const placeholder = type === 'video' ? 'Video Başlığı' : 'PDF Başlığı';

    row.innerHTML = `
        <input type="hidden" name="content_types[]" value="${type}">
        <input type="hidden" name="content_orders[]" class="content-order-input" value="${contentOrder}">
        <div class="col-md-1 text-center">
            <i class="bi bi-grip-vertical drag-handle"></i>
        </div>
        <div class="col-md-5">
            <input type="text" class="form-control" name="content_titles[]" placeholder="${placeholder}" required>
        </div>
        <div class="col-md-5">
            <input type="file" class="form-control" name="content_files[]" accept="${fileAccept}" required>
        </div>
        <div class="col-md-1 text-end">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.content-input-row').remove(); updateContentOrder();">Kaldır</button>
        </div>
    `;
    container.appendChild(row);
    contentOrder++;
}

function updateContentOrder() {
    const rows = document.querySelectorAll('#content-inputs .content-input-row');
    rows.forEach((row, index) => {
        row.querySelector('.content-order-input').value = index;
    });
    contentOrder = rows.length;
}

document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('content-inputs');
    if(container) {
        new Sortable(container, {
            animation: 150,
            handle: '.drag-handle',
            onEnd: function() {
                updateContentOrder();
            }
        });
    }

    if (container.children.length === 0) {
        addContentInput('video');
    }

    const testRequiredCheckbox = document.getElementById('test_required');
    const testFieldsWrapper = document.getElementById('test_fields_wrapper');
    if (testRequiredCheckbox && testFieldsWrapper) {
        const testInputs = testFieldsWrapper.querySelectorAll('input, select');

        const toggleTestFields = () => {
            const isChecked = testRequiredCheckbox.checked;
            testFieldsWrapper.style.display = isChecked ? 'block' : 'none';
            testInputs.forEach(input => {
                if (isChecked) {
                    if (input.name === 'test_file') {
                        input.setAttribute('required', 'required');
                    } else {
                        input.removeAttribute('required');
                    }
                } else {
                    input.removeAttribute('required');
                    if (input.type !== 'checkbox' && input.type !== 'radio') {
                       input.value = '';
                    }
                }
            });
        };

        toggleTestFields();
        testRequiredCheckbox.addEventListener('change', toggleTestFields);
    }
});
</script>
{% endblock %}
{% endblock %} 