{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="mb-2">Kurs İlerleme Durumu</h5>
                <div class="mb-1" style="font-weight: 500;">İlerleme: {{ completed_steps }}/{{ total_steps }} Aşama (%{{ progress_percent }})</div>
                <div class="progress mb-2" style="height: 24px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress_percent }}%; font-weight: bold; font-size: 1rem;" aria-valuenow="{{ progress_percent }}" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title">{{ video.title }}</h3>
                <video id="videoPlayer" class="w-100" controls controlsList="nodownload" preload="auto">
                    <source src="{{ url_for('static', filename='uploads/' + video.video_path) }}" type="video/mp4">
                    Tarayıcınız video oynatmayı desteklemiyor.
                </video>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Eğitim Durumu</h5>
                {% if progress and progress.completed %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Bu video tamamlandı!
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-clock"></i> Video henüz tamamlanmadı.
                    </div>
                {% endif %}
                
                <!-- Video bittiğinde görünecek tek buton -->
                <div id="nextStepSection" style="{% if progress and progress.completed %}display: block;{% else %}display: none;{% endif %}">
                    {% if next_url %}
                        {% if 'pdf-test' in next_url %}
                            <a href="{{ next_url }}" class="btn btn-warning btn-lg w-100 mb-3">
                                <i class="fas fa-clipboard-check"></i> Kursu Bitirme Testine Git
                            </a>
                        {% else %}
                            <a href="{{ next_url }}" class="btn btn-primary btn-lg w-100 mb-3">
                                <i class="fas fa-arrow-right"></i> Sonraki Adıma Geç
                            </a>
                        {% endif %}
                    {% else %}
                        <!-- Kurs tamamlandıysa dashboard'a git -->
                        <a href="{{ url_for('dashboard') }}" class="btn btn-success btn-lg w-100 mb-3">
                            <i class="fas fa-trophy"></i> Ana Sayfaya Git
                        </a>
                    {% endif %}
                    
                    <!-- Önceki içeriğe git butonu (video tamamlandıktan sonra) -->
                    {% if prev_url %}
                        <a href="{{ prev_url }}" class="btn btn-outline-secondary w-100 mb-3">
                            <i class="fas fa-arrow-left"></i> Önceki İçeriğe Git
                        </a>
                    {% endif %}
                    
                    <a href="{{ url_for('course', course_id=course.id) }}" class="btn btn-outline-info w-100">
                        <i class="fas fa-book"></i> Kurs Sayfasına Dön
                    </a>
                </div>

                <!-- Normal navigasyon butonları (video tamamlanmamışken) -->
                <div id="normalNavigation" style="{% if progress and progress.completed %}display: none;{% else %}display: block;{% endif %}">
                    <!-- Sadece önceki içerik butonu (eğer varsa) -->
                    {% if prev_url %}
                        <a href="{{ prev_url }}" class="btn btn-outline-secondary w-100 mb-3">
                            <i class="fas fa-arrow-left"></i> Önceki İçeriğe Git
                        </a>
                    {% endif %}

                    <a href="{{ url_for('course', course_id=course.id) }}" class="btn btn-outline-info w-100">
                        <i class="fas fa-book"></i> Kurs Sayfasına Dön
                    </a>
                    
                    <div class="alert alert-info mt-3">
                        <small><i class="fas fa-info-circle"></i> Videoyu sonuna kadar izleyin, ardından sonraki adıma geçebilirsiniz.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Video kontrollerini serbest bırak - kullanıcı istediği gibi kullanabilsin */
video::-webkit-media-controls-timeline {
    display: block !important;
}
video::-webkit-media-controls-seek-back-button,
video::-webkit-media-controls-seek-forward-button {
    display: block !important;
}
video::-webkit-media-controls-current-time-display,
video::-webkit-media-controls-time-remaining-display,
video::-webkit-media-controls-play-button,
video::-webkit-media-controls-volume-slider,
video::-webkit-media-controls-mute-button,
video::-webkit-media-controls-fullscreen-button {
    display: block !important;
}
</style>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('videoPlayer');

    console.log('Video player initialized, seeking is now allowed');

    // Video bittiğinde
    video.addEventListener('ended', function() {
        console.log('Video ended, starting completion process...');
        
        // Kullanıcıya bilgi ver
        const statusDiv = document.createElement('div');
        statusDiv.className = 'alert alert-info mt-3';
        statusDiv.innerHTML = '<i class="fas fa-hourglass-half"></i> Video tamamlandı, işleniyor...';
        video.parentNode.appendChild(statusDiv);
        
        console.log('Sending completion request to server...');
        
        fetch('/video/{{ video.id }}/complete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('Server response status:', response.status);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Server response data:', data);
            if (data.success) {
                statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Video kaydedildi!';
                statusDiv.className = 'alert alert-success mt-3';
                
                // Eğer sunucudan next_url geliyorsa, o URL'ye yönlendir
                if (data.next_url) {
                    setTimeout(() => {
                        window.location.href = data.next_url;
                    }, 1500);
                } else {
                    // Normal navigasyonu gizle, tamamlanma butonlarını göster
                    document.getElementById('normalNavigation').style.display = 'none';
                    document.getElementById('nextStepSection').style.display = 'block';
                    
                    // Sayfayı yenile ki progress bar güncellensin
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            } else {
                console.error('Server returned success=false');
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sunucu hatası!';
                statusDiv.className = 'alert alert-danger mt-3';
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Bağlantı hatası! Tekrar deneyin.';
            statusDiv.className = 'alert alert-danger mt-3';
        });
    });
});
</script>
{% endblock %}
{% endblock %} 